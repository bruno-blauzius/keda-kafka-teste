---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: policy-require-labels
  annotations:
    policies.kyverno.io/title: Require Standard Labels
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod, Deployment, Service
    policies.kyverno.io/description: >-
      Força uso de labels padrão para organização, rastreabilidade e automação. Labels obrigatórias: app, version, component, managed-by.
spec:
  validationFailureAction: Audit
  background: true
  rules:
  - name: check-required-labels
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          - DaemonSet
          - Service
    validate:
      message: >-
        Labels obrigatórias ausentes. Requeridas: app, version, component, managed-by. Exemplo: app=keda-kafka-consumer, version=v1, component=consumer, managed-by=keda
      pattern:
        metadata:
          labels:
            app: "?*"
            version: "?*"
            component: "?*"
            managed-by: "?*"
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: policy-validate-label-format
  annotations:
    policies.kyverno.io/title: Validate Label Format
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: low
    policies.kyverno.io/subject: Pod, Deployment
    policies.kyverno.io/description: >-
      Valida formato de labels: lowercase, alfanumérico, hífens permitidos.
spec:
  validationFailureAction: Audit
  background: true
  rules:
  - name: check-app-label-format
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          - DaemonSet
    validate:
      message: "Label 'app' deve ser lowercase e alfanumérica (hífens permitidos)."
      pattern:
        metadata:
          labels:
            app: "^[a-z0-9-]+$"
